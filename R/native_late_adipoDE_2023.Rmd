---
title: "day15_bulk_v_floating_adipoDE"
author: "Sarah Hazell Pickering"
date: "2/9/2022"
output: pdf_document
---

## Summary

The donor 1 floating adipocytes are quite different between replicates, but still very distinct from bulk adipocyte samples (see PCA plot).  Floating adipocytes are enriched for mitochondrial metabolism genes or adipogenesis hallmarks, whilst bulk samples are enriched for genes related to the extracellular matrix and/or blood vessel morphogenesis. 

Output file:

 - day15_bulk.v.float.tab
 
    which shows pvalues and logFCs for DE between bulk and floating adipocytes (D1 only and D2 only stats are given in the right most columns as well).


```{r message=F, warning=F}
library(limma)
library(biomaRt)
library(ggplot2)
library(RUVSeq)
library(clusterProfiler)
```


### Load read counts
```{r}
fc = read.delim(file.path("../02featureCounts/day15_bulk_v_float.counts"),
                header=T, stringsAsFactors = F, skip = 1)
colnames(fc) = gsub("output.01hisat.","", gsub(".sorted.bam","",colnames(fc)))
head(fc)
```
### Load sample information
```{r}
sample_info = read.delim("../sample_info/day15_bulk_v_float_info.csv", sep=",",
                header=T)
sample_info$sample_id = gsub("-",".", sample_info$sample_id)
sample_info$bio.condition = gsub(" ",".", sample_info$bio.condition)
sample_info
```

###Combine into DGE object
```{r}
ob = DGEList(counts = data.matrix(fc[7:ncol(fc)]),
             samples = sample_info,
             group = sample_info$bio.condition,
             genes = fc[c(1,6)])
rownames(ob$counts) = ob$genes$Geneid
```


## PCA

Bulk and floating transcriptomes are more different for donor1 than donor2.  This first dimension does separate bulk and floating (though better for donor1) and the second dimension seems to separate donors.  Bulk adipocytes have similarities between donors, but the floating adipocytes seem quite different from one another, even with donor1 there's a lot of variability.  

```{r}
mds = plotMDS(ob, labels = ob$samples$group, top=5000)
```

## Filtering

```{r}
plotRLE(ob$counts, outline=FALSE, col=ob$samples$group, main="Before Filtering")

plotSmear(ob, main = "Before Filtering")

nrow(ob) #58 735 genes before filtering
```


```{r}
filt = ob[filterByExpr(ob),, keep.lib.sizes=FALSE]
nrow(filt) #17 882 genes kept after filtering
```

The exact filter is approxiamtely 10/ libsize in millions (now about 0.2 CPM).  This is a lower filter than previous, I guess because our library sizes are bigger.  
```{r}
10/(median(ob$samples$lib.size)/1000000) #0.190 minimum CPM 
```

Hmm interesting there's higher expression in the floating samples, especially for lower CPM, higher sensitivity perhaps?  
```{r}
plotSmear(filt, main = "After Filtering, D1G") 
plotSmear(filt, main = "After Filtering, D2A", pair=c("D2A","D2A.floating")) 
plotRLE(filt$counts, outline=FALSE, 
        col=filt$samples$treat, main="After filtering")
```

Sanity check that the geneids haven't been mixed up.  
```{r}
filt$genes[filt$genes$Geneid == "ENSG00000228630",] #Hotair is still included

filt$genes[filt$genes$Geneid == "ENSG00000132170",] #PPARG is included
```
## Normalise

Hmm these libraries have quite a bit of substructure, the means are not around zero, and the variances have quite large differences, particularly for two of those donor1 floating samples.  You can see they sit differently in the PCA.  

```{r}
filt = calcNormFactors(filt,method = "TMM")
filt$samples[1:5]
plotRLE(cpm(filt$counts, normalized.lib.sizes =FALSE), outline=FALSE, 
             main="After TMM normalisation (no libsize)")

plotRLE(cpm(filt$counts, normalized.lib.sizes = TRUE), outline=FALSE, 
        col=filt$samples$group, main="After TMM normalisation (with libsize)")
```



## Annnotate with gene names

```{r}
mart <- biomaRt::useMart(biomart = "ensembl",
  dataset = "hsapiens_gene_ensembl",
  host = "jan2019.archive.ensembl.org")
annot = getBM(c("external_gene_name", "description", "ensembl_gene_id", "gene_biotype"), 
              filters = "ensembl_gene_id",
              values = as.character(filt$genes$Geneid),
              mart = mart,
              useCache = F)
head(annot)

#Tidying up the annot table
annot$description = gsub("\\[Source:.+\\]", "", annot$description)
colnames(annot)[1] = "gene_name"
colnames(annot)[3] = "gene"

#Add gene names to data object
filt$genes = merge(filt$genes, annot, by.x= "Geneid", 
                        by.y = "gene", sort=FALSE)
colnames(filt$genes) = c("gene","length","gene_name","description","gene_biotype")
head(filt$genes)
```


## Limma DE

```{r}
filt$samples$group = factor(filt$samples$group)
norm_ob = voom(filt, plot=T)
```

### Simple separate design

```{r}
design = model.matrix(~0+norm_ob$targets$group)
colnames(design) = levels(norm_ob$targets$group)
design

tests = makeContrasts(D1.bulk.v.float = D1G.floating - D1G,
                       D2.bulk.v.float = D2A.floating - D2A,
                      bulk.v.float = (D1G.floating - D1G) + (D2A.floating - D2A),
                      D1.v.D2 = D1G - D2A,
                      floating.D1.v.D2 = D1G.floating - D2A.floating,
                       levels = design) #test for which genes change the same 

simple_fit = lmFit(norm_ob, design=design)
simple_fit = contrasts.fit(simple_fit, tests)
simple_fit = eBayes(simple_fit, robust=T)

results= decideTests(simple_fit, method="separate", adjust.method = "BH")
summary(results)

summary(decideTests(simple_fit, method="separate", adjust.method = "BH", p.value = 0.01))
vennDiagram(results)
vennDiagram(results[,3:5])
```

It's worth being a little more stringent on the pvalue threshold as well, considering how many D1 genes are showing up.  

This is not a bad test, we have 213 genes that are found in all three tests and so seems robust.  Only two genes seem to be significant in opposite directions which is a good sign.  Interestingly the combined test picks up 563 genes that were ignored in the individual tests.  There are less genes found uniquely in each individual test than in the combined, which I also take as a good sign.  

```{r}
stringent = decideTests(simple_fit, method="global", adjust.method = "BH", p.value = 0.01)
summary(stringent)

vennDiagram(stringent[,3:5])
vennDiagram(stringent[,1:3])
```

## Make a combined table

In an ANOVA-style combined test 4.5k genes are different between bulk and floating (not shown). Instead I opted for the combined test, which presents 4.1k DE genes at a 0.01 pvalue threshold.  

Overwhelmingly significant genes are downregulated in floating cells, which makes sense with the loss of population diversity.  

Top gene preferentially expressed in bulk samples is MEG3, a potential lncRNA tumor supressor, via proliferation control.   Another top gene is WEE1, a negative regulator of mitosis entry.  There is also CDH11.  These genes are also pretty highly expressed.  

Genes preferentially expressed in floating adipocytes include a lot of TCA cycle and metabolism genes.  Though not in the top 10 galectin 12 is expressed by floating adipocytes, as well as some other galectins.   

```{r}
common = topTable(simple_fit, coef = "bulk.v.float", number=nrow(simple_fit$genes))
head(common[3:ncol(common)], n=10) #bulk genes

head(common[common$logFC > 0,3:ncol(common)], n=10)

common[grep("galectin", common$description),]

summary(common$adj.P.Val < 0.01)
```


```{r}
d1 = topTable(simple_fit, coef = "D1.bulk.v.float", number=nrow(simple_fit$genes))

d2 = topTable(simple_fit, coef = "D2.bulk.v.float", number=nrow(simple_fit$genes))

both = merge(d1, d2, suffixes=c("_d1", "_d2"), by=c("gene","length","gene_name","description", "gene_biotype"))
head(both)


all = merge(common, both, by=c("gene","length","gene_name","description", "gene_biotype"))
head(all)

all = all[grep("^(t.*|B_d.*|P.Value_d.*)", colnames(all), invert=T)]
all = all[order(all$adj.P.Val, -(all$B)),]
head(all)
```

```{r eval=F}
write.table(all,"../03limma/day15_bulk.v.float.tab"), 
            sep="\t", row.names=F, quote=F)
```

## Quick GO

```{r}
molsig <- clusterProfiler::read.gmt("../sample_info/msigdb.v7.4.symbols.gmt")
head(molsig); nrow(molsig)
##Pick gene sets to look in bcos all in a lot
prefixes = c("HALLMARK", "KEGG","REACTOME", "WP", "GOBP", "GOCC","GOMF")
colnames(molsig) = c("term","gene")
some.molsig = molsig[gsub("_.*","", molsig$term) %in% prefixes,]
some.molsig$term = factor(some.molsig$term)
table(gsub("_.*","", some.molsig$term))
```

Floating adipocytes are largely enriched for mitochondrial metabolism genes, but also 89 adipogenesis genes.  

```{r}
go_up = enricher(gene=common$gene_name[common$logFC > 0 &
                                      common$adj.P.Val < 0.01],
              TERM2GENE = some.molsig,
              minGSSize = 10, 
              universe = common$gene_name) #universe all expressed genes
print(head(go_up, n=10)[c(3:7)])

go_up[grep("ADIPO", go_up$ID), 3:9]

dotplot(go_up, showCategory=20)+ scale_y_discrete(label=function(x) tolower(stringr::str_trunc(x,45))) + 
theme(axis.text.y = element_text(size=10)) 
```

Bulk adipocytes are enriched for a variety of terms, with extracellular matrix very strong (likely driving the epithelial to mesenchymal gene set) as well as blood vessel and connective tissue GO terms.  In fact ~8% of significant protein coding genes are related to blood vessel morphogenesis (GeneRatio = 0.08).  

```{r}
go_down = enricher(gene=common$gene_name[common$logFC < 0 &
                                      common$adj.P.Val < 0.01],
              TERM2GENE = some.molsig,
              minGSSize = 10, 
              universe = common$gene_name) #universe all expressed genes
print(head(go_down, n=10)[c(3:7)])
barplot(go_down, showCategory=20)+ scale_x_discrete(label=function(x) tolower(stringr::str_trunc(x,45))) + 
theme(axis.text.y = element_text(size=10)) 
dotplot(go_down, showCategory=20)+ scale_y_discrete(label=function(x) tolower(stringr::str_trunc(x,45))) + 
theme(axis.text.y = element_text(size=10)) 

go_down[grep("MESENCHYMAL", go_down$ID), 3:9]
go_down[grep("EXTRACELLULAR", go_down$ID), 3:9]
go_down[grep("BLOOD_VESSEL", go_down$ID), 3:9]
```

```{r}
common[grep("SNAI", common$gene_name),]
```


## Volcanoplots

(-logfc is more expression in bulk adipocytes)

```{r}
volcanoplot(simple_fit, coef = "bulk.v.float", highlight=8, names = simple_fit$genes$gene_name)
volcanoplot(simple_fit, coef = "D1.bulk.v.float", highlight=2, names = simple_fit$genes$gene_name)
volcanoplot(simple_fit, coef = "D2.bulk.v.float", highlight=8, names = simple_fit$genes$gene_name)

```


## Check p-value distributions

Very strong effect for d1 and combined.  d2 looks robust as well.  
```{r}
ggplot(common) + geom_histogram(aes(x=P.Value), binwidth=0.01)

ggplot(d1) + geom_histogram(aes(x=P.Value), binwidth=0.01)

ggplot(d2) + geom_histogram(aes(x=P.Value), binwidth=0.01)
```
